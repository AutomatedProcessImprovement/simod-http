name: Deployment

on:
  workflow_dispatch:

jobs:
  deployment:
    runs-on: ubuntu-latest
    environment: 
      name: production
      url: http://simod.cloud.ut.ee/api/v1/docs
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
          submodules: true

      - name: Set up Ansible
        run: |
          sudo apt-get update
          sudo apt-get install --only-upgrade openssl
          sudo apt-get install -y python3-pip apache2-utils
          pip3 install -U pip ansible pyyaml
          ansible --version
          docker --version

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: "${{ secrets.PIX_SSH_KEY }}"
          name: "pix"
          known_hosts: "${{ secrets.KNOWN_HOSTS }}"

      - name: Deploy with Ansible
        run: |
          ansible-playbook -i ansible/hosts.yaml --private-key ~/.ssh/pix -v ansible/deploy.yaml
        env:
          FLOWER_USER: ${{ secrets.FLOWER_USER }}
          FLOWER_PASSWORD: ${{ secrets.FLOWER_PASSWORD }}
          SIMOD_ADMIN_USERNAME: ${{ secrets.SIMOD_ADMIN_USERNAME }}
          SIMOD_ADMIN_PASSWORD: ${{ secrets.SIMOD_ADMIN_PASSWORD }}
          SIMOD_SECRET_KEY: ${{ secrets.SIMOD_SECRET_KEY }}
